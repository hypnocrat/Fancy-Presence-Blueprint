blueprint:
  name: Presence Light with Dual Manual Overrides (Tuya RD24G01) - WORKING
  description: >
    Controls light(s) based on Tuya RD24G01 mmWave sensor.
    Implements dual manual overrides (ON/OFF) with duration timers.
    Optional disable sensor stops automation entirely.
    Only triggers between sunset and sunrise with customizable offset.
    This version uses the built-in 'sun' condition for guaranteed compatibility and modern logging.
  domain: automation

  input:
    presence_sensor:
      name: Tuya RD24G01 Presence Sensor
      selector:
        entity:
          domain: sensor

    target_lights:
      name: Lights (multi-select)
      selector:
        entity:
          domain: light
          multiple: true

    off_delay:
      name: Auto-off delay (seconds)
      default: 30
      selector:
        number:
          min: 1
          max: 600
          unit_of_measurement: seconds

    manual_on_override_flag:
      name: Manual ON Override Boolean Helper
      selector:
        entity:
          domain: input_boolean

    manual_off_override_flag:
      name: Manual OFF Override Boolean Helper
      selector:
        entity:
          domain: input_boolean

    manual_on_minutes:
      name: Manual ON Override Duration (minutes)
      default: 5
      selector:
        number:
          min: 1
          max: 120
          unit_of_measurement: minutes

    manual_off_minutes:
      name: Manual OFF Override Duration (minutes)
      default: 10
      selector:
        number:
          min: 1
          max: 240
          unit_of_measurement: minutes

    disable_sensor:
      name: Optional Disable Sensor
      description: If ON, automation is disabled.
      default: ""
      selector:
        entity:
          domain: binary_sensor

    sunset_offset:
      name: Sunset Offset (minutes)
      description: Offset the start of the time window. Use a negative number to start before sunset.
      default: 0
      selector:
        number:
          min: -120
          max: 120
          unit_of_measurement: minutes

    sunrise_offset:
      name: Sunrise Offset (minutes)
      description: Offset the end of the time window. Use a positive number to end after sunrise.
      default: 0
      selector:
        number:
          min: -120
          max: 120
          unit_of_measurement: minutes

    sun_entity:
      name: Sun Entity
      description: The sun entity to use for determining sunrise/sunset times.
      default: sun.sun
      selector:
        entity:
          domain: sun

trigger:
  - platform: state
    entity_id: !input presence_sensor
  - platform: state
    entity_id: !input target_lights

condition:
  # This single condition replaces the entire complex template block
  - condition: sun
    after: sunset
    after_offset: !input sunset_offset
    before: sunrise
    before_offset: !input sunrise_offset
    entity_id: !input sun_entity

action:
  - variables:
      sensor: !input presence_sensor
      lights: !input target_lights
      off_delay: !input off_delay
      on_flag: !input manual_on_override_flag
      off_flag: !input manual_off_override_flag
      on_minutes: !input manual_on_minutes
      off_minutes: !input manual_off_minutes
      disable_sensor: !input disable_sensor
      sun: !input sun_entity
      active_states: ["motion", "stationary"]

  # Log that we passed the time window check
  - service: system_log.write
    data:
      message: "Presence Light [{{ sensor }}]: [OK] Passed time window check."
      level: info

  ###########################################################################
  # 1 — Optional disable sensor
  ###########################################################################
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ disable_sensor != "" and is_state(disable_sensor, 'on') }}
        sequence:
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [FAIL] Stopped. Disable sensor '{{ disable_sensor }}' is ON."
              level: warning
          - stop:
  - service: system_log.write
    data:
      message: "Presence Light [{{ sensor }}]: [OK] Passed disable sensor check."
      level: info

  ###########################################################################
  # 2 — Manual ON override
  ###########################################################################
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.entity_id in lights
                 and trigger.to_state.state == 'on'
                 and trigger.to_state.context.user_id is not none }}
        sequence:
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [INFO] Manual ON override triggered. Activating flag and stopping automation."
              level: info
          - service: input_boolean.turn_on
            target:
              entity_id: !input manual_on_override_flag
          - wait_for_trigger:
              - platform: template
                value_template: "{{ is_state(sensor, 'none') }}"
          - delay:
              minutes: !input manual_on_minutes
          - service: input_boolean.turn_off
            target:
              entity_id: !input manual_on_override_flag
          - stop:

  ###########################################################################
  # 3 — Manual OFF override
  ###########################################################################
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ trigger.entity_id in lights
                 and trigger.to_state.state == 'off'
                 and trigger.to_state.context.user_id is not none }}
        sequence:
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [INFO] Manual OFF override triggered. Activating flag and stopping automation."
              level: info
          - service: input_boolean.turn_on
            target:
              entity_id: !input manual_off_override_flag
          - wait_for_trigger:
              - platform: template
                value_template: "{{ is_state(sensor, 'none') }}"
          - delay:
              minutes: !input manual_off_minutes
          - service: input_boolean.turn_off
            target:
              entity_id: !input manual_off_override_flag
          - stop:
  - service: system_log.write
    data:
      message: "Presence Light [{{ sensor }}]: [OK] Passed manual override checks."
      level: info

  ###########################################################################
  # 4 — Auto ON (blocked by OFF override)
  ###########################################################################
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_state(off_flag, 'off')
                 and trigger.entity_id == sensor
                 and trigger.from_state.state == 'none'
                 and trigger.to_state.state in active_states }}
        sequence:
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [OK] Auto-ON condition met. Turning lights on."
              level: info
          - service: light.turn_on
            target:
              entity_id: !input target_lights
    default:
      - service: system_log.write
        data:
          message: "Presence Light [{{ sensor }}]: [FAIL] Auto-ON condition NOT met. Details: OFF_Flag_is_off={{ is_state(off_flag, 'off') }}, Trigger_is_sensor={{ trigger.entity_id == sensor }}, FromState_was_none={{ trigger.from_state.state == 'none' }}, ToState_is_active={{ trigger.to_state.state in active_states }}"
          level: warning

  ###########################################################################
  # 5 — Auto OFF (blocked by ON override)
  ###########################################################################
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {{ is_state(on_flag, 'off')
                 and trigger.entity_id == sensor
                 and trigger.to_state.state == 'none'
                 and states(sensor) not in active_states }}
        sequence:
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [OK] Auto-OFF condition met. Starting delay."
              level: info
          - delay:
              seconds: !input off_delay
          - condition: template
            value_template: "{{ is_state(sensor, 'none') }}"
          - service: system_log.write
            data:
              message: "Presence Light [{{ sensor }}]: [OK] Delay finished. Sensor still 'none'. Turning lights off."
              level: info
          - service: light.turn_off
            target:
              entity_id: !input target_lights
    default:
      - service: system_log.write
        data:
          message: "Presence Light [{{ sensor }}]: [FAIL] Auto-OFF condition NOT met."
          level: warning

mode: queued
max: 20
